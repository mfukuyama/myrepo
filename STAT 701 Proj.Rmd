---
title: "STAT 701 Proj"
author: "Michael Fukuyama, Sami El Solh, Bryan Cai"
date: "05/09/2021"
output: html_document
---

```{r Setup, include=FALSE, results='hide', warning=FALSE}
knitr::opts_chunk$set(echo = T, fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output

# Package setup
if(!require("pacman")) install.packages("pacman")

# add packages if needed
pacman::p_load(tidyverse, dplyr, ggplot2, data.table, lubridate, glmnet, car, zoo, quantmod, BIS, tidyquant, plotly)
```

combine lists into single dataframe and clean dataframe
```{r read data}
filenames <- list.files(pattern = "*.csv")
data_list <- lapply(filenames,fread)
data <- rbindlist(data_list, fill = TRUE)

Filter(function(x)!all(is.na(x)), data)
data <- data[, -c(39:58)]

data = filter(data, grepl("2",Date))

data$Date <- as.yearmon(data$Date)

names(data) <- gsub(" ", "_", names(data))

names(data) <- gsub("-", "_", names(data))

names(data) <- gsub("&", "", names(data))
data
```

converting billions/millions/thousands into actual numbers
```{r convert numbers}
combined_table2 <- data %>% mutate( across( c(3:38),
                     ~ case_when(
                         str_detect(., 'B') ~ parse_number(as.character(.), na = c("", "NA")) * 1e9,
                         str_detect(., 'M') ~ parse_number(as.character(.), na = c("", "NA")) * 1e6,
                         str_detect(., 'K') ~ parse_number(as.character(.), na = c("", "NA")) * 1e3,
                         TRUE ~ parse_number(as.character(.), na = c("", "NA"), trim_ws = TRUE)
                     )
                     ))

combined_table2
```

% changes over time of everything on IS and useful financial ratios
```{r changes over time}
full_report <- combined_table2 %>%
  mutate(
    DE_Ratio = Total_Liabilities / Shareholders_Equity,
    Current_Ratio = Total_Current_Assets/Total_Current_Liabilities,
    Quick_Ratio = (Total_Current_Assets - Inventories)/Total_Current_Liabilities,
    RoE = Net_Income/Shareholders_Equity,
    QoQ_Pct_Growth_Accrued_Comprehensive_Inc = (Accrued_Comprehensive_Inc - lag(Accrued_Comprehensive_Inc))/lag(Accrued_Comprehensive_Inc),
    YoY_Pct_Growth_Accrued_Comprehensive_Inc = (Accrued_Comprehensive_Inc - lag(Accrued_Comprehensive_Inc, 4))/lag(Accrued_Comprehensive_Inc, 4),
    QoQ_Cost_of_Goods_Sold = (Cost_of_Goods_Sold - lag(Cost_of_Goods_Sold))/lag(Cost_of_Goods_Sold),
    YoY_Pct_Growth_Cost_of_Goods_Sold = (Cost_of_Goods_Sold - lag(Cost_of_Goods_Sold, 4))/lag(Cost_of_Goods_Sold, 4),
    QoQ_EPS_Basic = (EPS_Basic - lag(EPS_Basic))/lag(EPS_Basic),
    YoY_Pct_Growth_EPS_Basic = (EPS_Basic - lag(EPS_Basic, 4))/lag(EPS_Basic, 4),
    QoQ_Pct_Growth_EPS_Diluted = (EPS_Diluted - lag(EPS_Diluted))/lag(EPS_Diluted),
    YoY_Pct_Growth_EPS_Diluted = (EPS_Diluted - lag(EPS_Diluted, 4))/lag(EPS_Diluted, 4),
    QoQ_Pct_Growth_Net_Income = (Net_Income - lag(Net_Income))/lag(Net_Income),
    YoY_Pct_Growth_Net_Income = (Net_Income - lag(Net_Income, 4))/lag(Net_Income, 4),
    QoQ_Pct_Growth_Net_Non_Operating_Interest_Income_Expense = (Net_Non_Operating_Interest_Income_Expense - lag(Net_Non_Operating_Interest_Income_Expense))/lag(Net_Non_Operating_Interest_Income_Expense),
    YoY_Pct_Growth_Net_Non_Operating_Interest_Income_Expense = (Net_Non_Operating_Interest_Income_Expense - lag(Net_Non_Operating_Interest_Income_Expense, 4))/lag(Net_Non_Operating_Interest_Income_Expense, 4),
    QoQ_Pct_Growth_Net_Operating_Interest_Income = (Net_Operating_Interest_Income - lag(Net_Operating_Interest_Income))/lag(Net_Operating_Interest_Income),
    YoY_Pct_Growth_Net_Operating_Interest_Income = (Net_Operating_Interest_Income - lag(Net_Operating_Interest_Income, 4))/lag(Net_Operating_Interest_Income, 4),
    QoQ_Pct_Growth_Operating_Income = (Operating_Income - lag(Operating_Income))/lag(Operating_Income),
    YoY_Pct_Growth_Operating_Income = (Operating_Income - lag(Operating_Income, 4))/lag(Operating_Income, 4),
    QoQ_Pct_Growth_Pre_Tax_Income = (Pre_Tax_Income - lag(Pre_Tax_Income))/lag(Pre_Tax_Income),
    YoY_Pct_Growth_Pre_Tax_Income = (Pre_Tax_Income - lag(Pre_Tax_Income, 4))/lag(Pre_Tax_Income, 4),
    QoQ_Pct_Growth_Provision_for_Income_Taxes = (Provision_for_Income_Taxes - lag(Provision_for_Income_Taxes))/lag(Provision_for_Income_Taxes),
    YoY_Pct_Growth_Provision_for_Income_Taxes = (Provision_for_Income_Taxes - lag(Provision_for_Income_Taxes, 4))/lag(Provision_for_Income_Taxes, 4),
    QoQ_Pct_Growth_Research_and_Development_Expense = (Research_and_Development_Expense - lag(Research_and_Development_Expense))/lag(Research_and_Development_Expense),
    YoY_Pct_Growth_Research_and_Development_Expense = (Research_and_Development_Expense - lag(Research_and_Development_Expense, 4))/lag(Research_and_Development_Expense, 4),
    QoQ_Pct_Growth_Revenue = (Revenue - lag(Revenue))/lag(Revenue),
    YoY_Pct_Growth_Revenue = (Revenue - lag(Revenue, 4))/lag(Revenue, 4),
    QoQ_Pct_Growth_SGA_Expense = (SGA_Expense - lag(SGA_Expense))/lag(SGA_Expense),
    YoY_Pct_Growth_SGA_Expense = (SGA_Expense - lag(SGA_Expense, 4))/lag(SGA_Expense, 4),
    QoQ_Pct_Growth_Total_Operating_Expenses = (Total_Operating_Expenses - lag(Total_Operating_Expenses))/lag(Total_Operating_Expenses),
    YoY_Pct_Growth_Total_Operating_Expenses = (Total_Operating_Expenses - lag(Total_Operating_Expenses, 4))/lag(Total_Operating_Expenses, 4)
  )

full_report
```
joining interest rates to table
```{r interest rates}
datasets <- get_datasets()

interest_data <- get_bis(datasets$url[datasets$name == "Policy rates (monthly)"],quiet = TRUE)

interest_rates <- interest_data %>% 
  select(reference_area, date, obs_value) %>%
  filter(reference_area == "United States" & date >= 2011-01-01)

interest_rates$date <- as.yearmon(interest_rates$date)

names(interest_rates)[3] <- "US_key_interest_rate"

interest_rates<- interest_rates %>%
  select(date, US_key_interest_rate)

names(interest_rates)[1] <- "Date"

joined_interest_rates <- left_join(full_report, interest_rates, by = "Date")
joined_interest_rates
```

finding stock and VIX info


```{r stock prices}
tickers <- c("A","AAL","AAP","AAPL")
sd <- as.Date("2011-01-01")
ed <- as.Date("2021-03-30")

stock_prices <- tq_get(tickers, 
       from = sd, 
       to = ed ) %>%
  select(symbol, date, close) %>% 
  arrange(symbol)

colnames(stock_prices)[1] <- "Ticker"
colnames(stock_prices)[2] <- "Date"
colnames(stock_prices)[3] <- "Stock_Close"

stock_prices$last_weekday_date <- ave( 
  stock_prices$Date, 
  months(stock_prices$Date), 
  year = year(stock_prices$Date),
  FUN = function(x) tail(x[ !(weekdays(x) %in% c("Saturday","Sunday")) ], 1) 
)

stock_prices <- stock_prices %>% 
  select(Ticker, Date, Stock_Close, last_weekday_date) %>%
  filter(Date == last_weekday_date)

stock_prices$Date <- as.yearmon(stock_prices$Date)

stock_prices

joined_stock <- left_join(joined_interest_rates, stock_prices, by=c("Ticker" = "Ticker", "Date" = "Date"))
joined_stock
```

```{r VIX}
VIX <- getSymbols("^VIX", src = "yahoo", from = "2011-01-01", to = "2020-12-31", auto.assign = FALSE)

VIX <- as.data.frame(as.matrix(VIX))

VIX <- cbind(date = rownames(VIX), VIX)
rownames(VIX) <- 1:nrow(VIX)

VIX$newdate <- as.Date(VIX$date)
VIX$VIX <- as.numeric(VIX$VIX.Open)
VIX$VIX.High <- as.numeric(VIX$VIX.High)
VIX$VIX.Low <- as.numeric(VIX$VIX.Low)
VIX$VIX.Close <- as.numeric(VIX$VIX.Close)
VIX$VIX.Volume <- as.numeric(VIX$VIX.Volume)
VIX$VIX.Adjusted <- as.numeric(VIX$VIX.Adjusted)

VIX$last_weekday_date <- ave( 
  VIX$newdate, 
  months(VIX$newdate), 
  year = year(VIX$newdate),
  FUN = function(x) tail(x[ !(weekdays(x) %in% c("Saturday","Sunday")) ], 1) 
)

VIX$date <- as.yearmon(VIX$date)

colnames(VIX)[1] <- "Date"

VIX <- VIX %>% 
  select(Date, VIX.Close, newdate, last_weekday_date) %>%
  filter(newdate == last_weekday_date)

VIX <- VIX[,-3:-4] 

VIX

joined_stock_VIX <- left_join(joined_stock, VIX, by = "Date")
joined_stock_VIX
```

joining file with industry of companies
```{r company sector}
ind <- data.table::fread("/Users/micha/OneDrive/Documents/R/SP500_2017.csv")
joined_stock_VIX_ind <- left_join(joined_stock_VIX, ind, by=c("Ticker" = "Ticker_Symbol"))

joined_stock_VIX_ind
```
calculating change in interest rate, stock price, and VIX
```{r join stock and VIX to original table}
final_full_report <- joined_stock_VIX_ind %>%
  mutate(
    QoQ_Pct_Growth_US_key_interest_rate = (US_key_interest_rate - lag(US_key_interest_rate))/lag(US_key_interest_rate),
    YoY_Pct_Growth_US_key_interest_rate = (US_key_interest_rate - lag(US_key_interest_rate, 4))/lag(US_key_interest_rate, 4),
    QoQ_Pct_Growth_Stock_Price = (Stock_Close - lag(Stock_Close))/lag(Stock_Close),
    YoY_Pct_Growth_Stock_Price = (Stock_Close - lag(Stock_Close, 4))/lag(Stock_Close, 4),
    QoQ_Pct_Growth_VIX = (VIX.Close - lag(VIX.Close))/lag(VIX.Close),
    YoY_Pct_Growth_VIX = (VIX.Close - lag(VIX.Close, 4))/lag(VIX.Close, 4),
)

final_full_report
```
industry count of stocks
```{r count stocks by industry}
final_full_report %>% 
  group_by(Sector) %>% 
  summarise(count = n_distinct(Ticker))
```
graph of log stock price by quarter and industry
```{r change in stock price graph}
stock_plot <- final_full_report %>%
  ggplot(aes(x = Date, y = log(Stock_Close), group = Sector, col = Sector)) + 
  geom_line() + 
  geom_point() +
  theme_bw() 
ggtitle("Log Stock Price by Quarter and Industry")

ggplotly(stock_plot + 
           theme(legend.position = "none"))
```
